from sklearn.metrics.pairwise import cosine_similarity
import joblib

# Ensure product names are strings — this prevents KeyError
customer_product_matrix.columns = customer_product_matrix.columns.astype(str)

# Create similarity matrix
product_similarity = cosine_similarity(customer_product_matrix.T)

# Create DataFrame with string indices and columns
product_similarity_df = pd.DataFrame(
    product_similarity,
    index=customer_product_matrix.columns,
    columns=customer_product_matrix.columns
)

# Convert all to strings again (precaution)
product_similarity_df.columns = product_similarity_df.columns.astype(str)
product_similarity_df.index = product_similarity_df.index.astype(str)

# Save using joblib with protocol 4
joblib.dump(product_similarity_df, "product_similarity.pkl", protocol=4)

print("✅ Cleaned and saved product_similarity.pkl")
